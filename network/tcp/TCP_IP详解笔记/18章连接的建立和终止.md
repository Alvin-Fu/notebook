# 连接的建立与终止
[TCP/IP详解目录](http://www.52im.net/topic-tcpipvol1.html)
[第十八章](http://docs.52im.net/extend/docs/book/tcpip/vol1/18/)
## 摘要
TCP是面向连接的，因此使用TCP进行传输数据的时候是需要有建立连接和终止连接的过程。
探寻连接建立和终止的过程。

## 连接的建立
客户端通过发送SYN包到服务端，服务端收到后回复ACK包告诉客户端自己收到了，并会给服务端回复报文，这里称为三次握手。
## 连接的终止
由于TCP是全双工的，因此在终止连接的时候需要双方都进行确认，都需要放松FIN包来关闭连接，需要4次挥手
## 最大报文长度
最大报文长度(MSS)表示TCP传往另一端的最大块数据的长度。当连接建立的时候双方都要告知彼此自己的MSS大小
MTU最大传输单元，表示网络层能够传输的最大IP包
MSS是传输层的概念，是TCP数据包每次能够传输的最大量
以太网最大的数据帧是1518字节，以太网的帧头是14字节和帧尾CRC校验4字节共占18字节，一次DATA域为1500字节即MTU(即网络层能传输的最大IP包)
在TCP中往往使用MTU代替MSS(在这里减去20字节的IP包头和20字节的TCP包头)，通常MSS为1460
MSS都是在SYN包中出现的。
在以太网中由于有很多的路由，每快的MSS可能都不太一样，这时是通过MSS发现机制去发现的，一般使用最小的MSS进行发包，因为如果TCP包大于时在IP层会进行分片，分片会降低性能。

## TCP的状态迁移图
下图就是TCP中的状态迁移过程，看着是一个比较复杂的图，这个里面包含了tcp的不同情况下的状态迁移。主要分为两部分一部分是客户端的状态变化，一部分是服务端的状态变化。
![TCP的状态迁移图](../../../.local/static/2020/11/5/110924s3zzfzfff8y1ht6x.1608834077043.png)
### 客户端的状态变化
CLOSED--->SYNSENT--->ESTABLIDSHED--->FIN_WAIT_1--->FIN_WAIT_2--->TIME_WAIT,正常情况下客户端的状态变化是这样的

### 服务端的状态变化
CLOSED--->LISTEN--->SYN收到--->ESTABLIDSHED--->CLOSE_WAIT--->LAST_ACK--->CLOSED。服务端收到了客户端的SYN时进行三次握手建立连接，当客户端发送FIN时服务端经过两个状态，在LAST_ACK时需要收到客户端的ACK才能恢复到最初的状态。
### 图中的其他状态
- LISTEN--->SYN_SENT: 这个表示服务端有时候也时需要建立连接的
- SYN_SENT--->SYN收到：客户端和服务端如果在SYN_SENT状态时如果收到了SYN，都需要回复SYN的ACK，然后将自己调整到ESTABLIDSHED状态
- SYN_SENT--->CLOSED: 发送超时的情况下需要进入CLOSED
- SYN收到--->LISTEN: 表示收到了RST包，然后返回到LISTEN(当一方断电等情况，另一方不知道的时候，进行发包的时候另一端会返回一个RST包)
- SYN收到--->FIN_WAIT_1：在建立连接后不进行到ESTABLIDSHED状态，然后连接被关闭了
### MSL等待
MSL是每个具体的TCP实现都必须选择一个报文段最大生存时间MSL,报文段被丢弃之前在网络中最长时间。
这个等待是主动发起一方才会有的(例外就是双方同时关闭)，这个等待是防止网络中还有之前连接的包，在2MSL之后网络中老的包都会消失，不会影响新的连接。
### FIN_WAIT_2状态
这个状态是本方发送了FIN后，对方返回了ACK后，本方进入的等待对方发送FIN的状态。
如果对方一直不发送FIN过来，这样就进入了半关闭的状态，这样客户端就一直在FIN_WAIT_2状态，而服务端就一直在CLOSE_WAIT状态，直到应用程序去关闭他

## RST，同时打开和同时关闭
RST也是一种关闭连接的方式，应用程序需要识别RST的有效性，防止恶意的RST包，将连接踢掉。
同时打开和同时关闭，这两种情况极少出现，同时打开是指双方同时发出SYN包；同时关闭指双方同时发送FIN包最后双方都会进入到TIME_WAIT状态。

## 一些思考
1、TCP收到的数据包都会回复一个确认包，这些数据包是否会和一些数据包合并在一起发送出去？
2、如何不通过Listen建立TCP连接[文章](https://zhuanlan.zhihu.com/p/334649587)






























