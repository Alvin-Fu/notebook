## 简介
tcpdump是一个网络数据包截获分析工具
## 常用的格式
### 指定网卡
`tcpdump -i en0`
**指定协议**
TCP/UDP
只想监听TCP `tcpdump tcp`
### 指定ip和端口
**指定特定主机**
`tcpdump host 182.123.13.1`  会监听本机和主机之间的所有通信包
**指定来源**
`tcpdump src host 182.123.13.1`
**指定目标**
`tcpdump dst host 182.123.13.1`
**指定端口**
`tcpdump port 8000`
## 例子
**and的使用**
`tcpdump ip host 182.123.13.2 and ! 182.123.13.1`表示182.123.13.2除了和182.123.13.1之外的主机的通信
没有！表示他们之间的通信
**详细的例子**
`tcpdump tcp -i en0 -t -s 0 -c 100 and dst port ! 22 and src net 182.123.13.0/24 -w ./target.cap`
- tcp: ip,icmp,tcp,udp等这些选项需要是第一个
- -i en0: 表示只抓经过en0的包
- -t： 表示不显示时间戳
- -s 0：表示抓取全部的包，默认是抓取68个字节
- -c 100: 表示抓取100个包
- dst port ! 22: 表示不抓取目标端口是22的包
- src net 182.123.13.0/24: 数据包的源网络地址为182.123.13.0/24
- -w ./target.cap: 保存成cap文件，方便分析
## wireshark的使用
**常见的TCP层的flags**
|标志位|描述|备注|
|-|-|-|
|SYN|建立连接||
|ACK|确认||
|PSH|有DATA数据传输||
|FIN|关闭连接||
|RST|连接重置||
根据三次握手的图可以知道只有当SYN和ACK都为1时表示客户端和服务端连接建立，SYN为1表示建立连接

### 过滤
|格式|描述|备注|
|-|-|-|
|ip.src == addr|源地址||
|ip.dst == addr|目标地址||
|ip.addr == addr|只要有addr的|ip.src == addr or ip.dst == addr|
|!(表达式)|表示不包含括号里面的||
|tcp.port == 80| 某个端口|udp.port,捕获多个可以用and，也可以使用大于等于这些|



### 抓包异常数据解读
#### 1、[TCP Previous segment not captured]丢包
TCP传输过程中数据包应该是连续的，后一个包的seq(n)=seq(n-1) + len(n-1),如果seq(n)>seq(n-1) + len(n-1)说明中间有一段数据丢失了。
[TCP Out-of-Order]表示包乱序了，比如seq(n) < seq(n-1)表示包的顺序错了
#### 2、[TCP Dup ACK x#y]
当乱序或在丢包发生时，接收方会收到一个比期望大的seq号。这时接收方会告知发送方当前他想要的包的seq
#### 3、[TCP Spurious Retransmission] 丢包重传
#### 4、[TCP Fast Retransmission] 快速重传
当发送方收到三个以上的[TCP Dup ACK]，就说明之前法的包可能丢了，于是快速重传他(RFC的规定)
#### 5、[TCP Retransmission]超时重传
如果一个包真的丢了，又没有后续包可以在接收方触发[Dup Ack],就不会快速重传，只能超时重传。
这时接收方和发送方之间没有其他包的往来，导致ACK和seq不能更新。
#### 6、[TCP ACKed unseen segment]
这个标志表示抓包发现被ack的包但是没有被抓到
42号包是序号27741 + 1460 = 29201 
说明29201到33581之间的数据没有抓到但是被确认了
![title](../../.local/static/2021/0/1/Snipaste_2021-01-11_10-52-17.1610362412869.png)
### TCP连接中出现RST的情况
1. 端口没有打开，连接一个没有打开的端口时
2. 请求超时查看两次包的时间间隔
3. 服务端关闭的socket，客户端关闭服务端也会收到
4. 防火墙拒绝请求
5. 移动链路，移动网络下，国内时有5分钟后就回收信令，也就是IM产品，如果心跳>5分钟后服务器在给客户端发消息，就会收到rst。尽量保持心跳在5min以内
6. 负载均衡等设备，在给双方转包的时候(和策略有关)，如果长时间无流量，连接也会被清除，而不告诉两端，新的包来时才告诉rst  apple push服务会有这个问题
7. 超过超时重传次数，网络暂时不可达
存在RST攻击，攻击者可能伪装后发送RST包让服务端将正常的连接断开，可以在防火墙出配置拦截RST包。
























