# redis的高可用方案
在redis中有三种高可用方案，主从，哨兵和集群模式。可靠性依次变高，复杂程度也变高。

## 主从模式
主从模式就是部署多个节点，其中主节点可以进行读写，从节点只能进行读，从节点需要同步主节点的数据，一个主节点可以有多个从节点，一个从节点只会有一个主节点。
主节点的配置使用普通的配置就好了
从节点需要配置主节点的登陆密码，主从复制相关的参数
```shell
 # 配置主节点的ip和端口
 slaveof 192.168.1.10 6379
 # 从redis2.6开始，从节点默认是只读的
 slave-read-only yes
 # 假设主节点有登录密码，是123456
 masterauth 123456
```

优点：

1. 使用和配置简单，可以实现读写分离
2. 从节点可以分担主节点的读压力
3. 从节点可以接受其他从节点的连接和同步请求
4. 主从节点都是以非阻塞的方式提供服务，在同步的时候依然可以对外提供服务

缺点：

1. 当出现主节点宕机的时候，需要手动就干预，不能自动选举出主节点
2. 主节点宕机的时候，会导致数据不一致，还有一部分数据没有同步
3. 如果同时启动多个从节点会导致，多个从节点在相同的时间请求同步，导致主节点的IO压力过大，可能会导致宕机
4. 在线扩容很难

## 哨兵模式
为了解决主从模式下需要手动干预把从节点切换成主节点，这个在生产环境是很致命的，我们需要的是可以自动选举的。为了解决这个问题redis中提供了一个redis-sentinel命令，哨兵是一个独立的进程，哨兵进程向所有的redis节点发送命令，等待响应，判断节点的状态。
哨兵一般是奇数个方便决策，哨兵之间可以互相监控。当发现master宕机，哨兵之间会决策选举新的master
哨兵按照一定的间隔向节点发送ping命令，超过配置的时间就标记主观下线，然后所有的哨兵都要向master发送ping命令，当有足够数量的哨兵在指定的时间范围内确认master是主观下线，这时master被标记为客观下线
这时哨兵会向下线的mater的所有从节点1秒发送一次INFO命令
若没有足够的哨兵同意master下线，这时客观下线状态会被移除

优点：

1. 拥有主从的优点
2. 可以自动切换，系统更健壮，可用性高

缺点：

1. 内存可用性低
2. 难以支持在线扩容

## 集群模式
为了解决哨兵模式的在线扩容难，redis的集群模式就应运而生

### Cluster模式
redis中使用的集群模式没有使用[一致性hash算法](https://github.com/Alvin-Fu/notebook/blob/master/micro-service/%E9%9D%A2%E4%B8%B4%E7%9A%84%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E5%BC%8F/%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95.md)，而是使用了slots插槽。
redis的哨兵模式基本已经可以实现高可用，读写分离。但是这种模式存在浪费内存。因此在redis3.0上加上了Cluster集群模式，实现分布是存储，对数据进行分片，即每个redis节点存储不同的内容。集群中一般最少部署三个主节点，三个从节点，共计6个节点

开启集群模式
```shell
 # 开启redis的集群模式
 cluster-enabled yes
 # 配置集群模式下的配置文件名称和位置,redis-cluster.conf这个文件是集群启动后自动生成的，不需要手动配置。
 cluster-config-file redis-cluster.conf
```

**运行机制**
每一个redis节点上都会有两个东西，一个插槽(slot)范围0-16383；另一个就是cluster，集群管理的插件，类似于哨兵。
接收到key的时候会使用crc16算法对key计算并对16383进行取余，将结果放到插槽所对应的节点
在redis-cluster集群中也引入了主从模式，用来保证高可用，当其他主节点ping主节点master1的时候半数以上的都超时，时认为master1宕机，会启用master1的从节点slave1变成主节点。如果都宕机了，整个集群进入fail状态，因为slot的映射不完整了。如果集群中有半数的master都宕机了无论是否有slave整个集群都进入fail状态。
cluster是去中心化的没有代理层，客户端和节点是直连的

**扩容和缩容**
使用集群管理工具redis-tri.rb
扩容时使用redis-tri.rb add-node将节点加入到集群中，然后分配slot，使用redis-tri.rb reshard进行分配重哈希，然后将旧节点上的slots分配到新节点上
缩容时使用redis-tri.rb reshard移除机器上的slots，然后使用redis-tri.rb add-del移除机器。

优点：

- 去中心化思想，数据按照slot存储分布在多个节点，节点间数据共享，可动态调整数据分布
- 可扩展性：可线性扩展到1000多个节点，节点可动态添加或删除
- 高可用性：部分节点不可用时集群仍可用
- 降低运维成本，提高系统的扩展性和可用性

缺点：

- redis Cluster集群时无中心节点的集群架构，依靠Goss协议协同自动化修复集群的状态。有消息延时和冗余问题，当节点过多时节点之间的ping/pang通讯会占用大量网络资源
- 数据迁移问题，在扩容或者缩容的时候还需要人工干预，并且为了保证数据一致性，迁移所有操作都是同步操作，迁移时两端的redis都会进入阻塞状态，对于大key来说这个是很致命的。




## 参考
[redis高可用模式](https://zhuanlan.zhihu.com/p/177000194)





















